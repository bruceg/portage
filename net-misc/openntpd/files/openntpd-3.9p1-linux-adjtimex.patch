diff -urN openntpd-3.9p1/client.c openntpd-3.9p1-linux-adjtimex/client.c
--- openntpd-3.9p1/client.c	2006-05-13 23:29:21.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/client.c	2006-05-31 13:36:34.000000000 -0600
@@ -321,7 +321,7 @@
 	priv_adjtime();
 
 	for (i = 0; i < OFFSET_ARRAY_SIZE; i++)
-		if (p->reply[i].rcvd <= p->reply[best].rcvd)
+		/* if (p->reply[i].rcvd <= p->reply[best].rcvd) */
 			p->reply[i].good = 0;
 
 	return (0);
diff -urN openntpd-3.9p1/config.h.in openntpd-3.9p1-linux-adjtimex/config.h.in
--- openntpd-3.9p1/config.h.in	2006-05-13 23:29:24.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/config.h.in	2006-05-31 13:37:22.000000000 -0600
@@ -331,6 +331,9 @@
 /* Define to 1 if you have the ANSI C header files. */
 #undef STDC_HEADERS
 
+/* Use adjust skew with adjtimex (experimental) */
+#undef USE_ADJTIMEX
+
 /* Use SIOCGIFCONF ioctl if we do not have getifaddrs() */
 #undef USE_SIOCGIFCONF
 
diff -urN openntpd-3.9p1/configure openntpd-3.9p1-linux-adjtimex/configure
--- openntpd-3.9p1/configure	2006-05-13 23:31:37.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/configure	2006-05-31 13:37:02.000000000 -0600
@@ -719,13 +719,13 @@
   	  /^X\(\/\).*/{ s//\1/; q; }
   	  s/.*/./; q'`
   srcdir=$ac_confdir
-  if test ! -r $srcdir/$ac_unique_file; then
+  if test ! -r "$srcdir/$ac_unique_file"; then
     srcdir=..
   fi
 else
   ac_srcdir_defaulted=no
 fi
-if test ! -r $srcdir/$ac_unique_file; then
+if test ! -r "$srcdir/$ac_unique_file"; then
   if test "$ac_srcdir_defaulted" = yes; then
     { echo "$as_me: error: cannot find sources ($ac_unique_file) in $ac_confdir or .." >&2
    { (exit 1); exit 1; }; }
@@ -734,7 +734,7 @@
    { (exit 1); exit 1; }; }
   fi
 fi
-(cd $srcdir && test -r ./$ac_unique_file) 2>/dev/null ||
+(cd $srcdir && test -r "./$ac_unique_file") 2>/dev/null ||
   { echo "$as_me: error: sources are in $srcdir, but \`cd $srcdir' does not work" >&2
    { (exit 1); exit 1; }; }
 srcdir=`echo "$srcdir" | sed 's%\([^\\/]\)[\\/]*$%\1%'`
@@ -855,6 +855,7 @@
   --with-privsep-path=path Specify privilege separation chroot path
   --with-builtin-arc4random Use builtin arc4random rather than OpenSSL's
   --with-mantype=man|cat|doc  Set man page type
+  --with-adjtimex         Use adjtimex to adjust kernel skew
   --with-ssl-dir=PATH     Specify path to OpenSSL installation
 
 Some influential environment variables:
@@ -9508,6 +9509,18 @@
 fi
 
 
+
+# Check whether --with-adjtimex or --without-adjtimex was given.
+if test "${with_adjtimex+set}" = set; then
+  withval="$with_adjtimex"
+
+cat >>confdefs.h <<\_ACEOF
+#define USE_ADJTIMEX
+_ACEOF
+
+
+fi;
+
 # Search for OpenSSL if required.
 if test "$ac_cv_func_arc4random" != "yes" && test "x$builtin_arc4random" != "xyes"; then
 saved_CPPFLAGS="$CPPFLAGS"
diff -urN openntpd-3.9p1/configure.ac openntpd-3.9p1-linux-adjtimex/configure.ac
--- openntpd-3.9p1/configure.ac	2006-05-13 23:29:23.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/configure.ac	2006-05-31 13:36:34.000000000 -0600
@@ -617,6 +617,11 @@
 fi
 AC_SUBST(mansubdir)
 
+AC_ARG_WITH(adjtimex,
+	[  --with-adjtimex         Use adjtimex to adjust kernel skew],
+	[ AC_DEFINE(USE_ADJTIMEX, [], [Use adjust skew with adjtimex (experimental)]) ]
+)
+
 # Search for OpenSSL if required.
 if test "$ac_cv_func_arc4random" != "yes" && test "x$builtin_arc4random" != "xyes"; then
 saved_CPPFLAGS="$CPPFLAGS"
diff -urN openntpd-3.9p1/defines.h openntpd-3.9p1-linux-adjtimex/defines.h
--- openntpd-3.9p1/defines.h	2006-05-13 23:29:21.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/defines.h	2006-05-31 13:36:34.000000000 -0600
@@ -20,6 +20,10 @@
 # define setproctitle(x)
 #endif
 
+#ifdef USE_ADJTIMEX
+# define adjtime(a,b)	(_compat_adjtime((a),(b)))
+#endif
+
 #if !defined(SA_LEN)
 # if defined(HAVE_STRUCT_SOCKADDR_SA_LEN)
 #  define SA_LEN(x)	((x)->sa_len)
Files openntpd-3.9p1/openbsd-compat/.port-linux.c.swp and openntpd-3.9p1-linux-adjtimex/openbsd-compat/.port-linux.c.swp differ
diff -urN openntpd-3.9p1/openbsd-compat/Makefile.in openntpd-3.9p1-linux-adjtimex/openbsd-compat/Makefile.in
--- openntpd-3.9p1/openbsd-compat/Makefile.in	2006-05-13 23:29:19.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/openbsd-compat/Makefile.in	2006-05-31 13:36:34.000000000 -0600
@@ -9,7 +9,7 @@
 COMPAT=		atomicio.o bsd-arc4random.o bsd-misc.o bsd-poll.o \
 		bsd-snprintf.o bsd-getifaddrs.o bsd-setresuid.o \
 		bsd-setresgid.o fake-rfc2553.o
-PORT=		port-qnx.o
+PORT=		port-linux.o port-qnx.o
 
 VPATH=@srcdir@
 CC=@CC@
diff -urN openntpd-3.9p1/openbsd-compat/openbsd-compat.h openntpd-3.9p1-linux-adjtimex/openbsd-compat/openbsd-compat.h
--- openntpd-3.9p1/openbsd-compat/openbsd-compat.h	2006-05-13 23:29:19.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/openbsd-compat/openbsd-compat.h	2006-05-31 13:36:34.000000000 -0600
@@ -46,6 +46,11 @@
                 __attribute__((__format__ (printf, 2, 3)));
 #endif
 
+#ifdef USE_ADJTIMEX
+# include <sys/time.h>
+int _compat_adjtime(const struct timeval *, struct timeval *);
+#endif
+
 #ifndef HAVE_INET_PTON
 int inet_pton(int, const char *, void *);
 #endif
diff -urN openntpd-3.9p1/openbsd-compat/port-linux.c openntpd-3.9p1-linux-adjtimex/openbsd-compat/port-linux.c
--- openntpd-3.9p1/openbsd-compat/port-linux.c	1969-12-31 18:00:00.000000000 -0600
+++ openntpd-3.9p1-linux-adjtimex/openbsd-compat/port-linux.c	2006-06-02 12:36:18.000000000 -0600
@@ -0,0 +1,104 @@
+/* $Id$ */
+
+/*
+ * Copyright (c) 2004 Darren Tucker <dtucker at zip com au>
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+ * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+#include "includes.h"
+
+#ifdef USE_ADJTIMEX
+#include <sys/timex.h>
+#include <errno.h>
+#ifdef adjtime
+# undef adjtime
+#endif
+
+#include "ntpd.h"
+
+/* scale factor used by adjtimex freq param.  1 ppm = 65536 */
+#define ADJTIMEX_FREQ_SCALE 65536
+
+/* maximum change to skew per adjustment, in PPM */
+#define MAX_SKEW_DELTA 100.0
+
+int
+_compat_adjtime(const struct timeval *delta, struct timeval *olddelta)
+{
+	static struct timeval tlast = {0,0};
+	static double tskew = 0;
+	static int synced = -1;
+	struct timeval tnow, tdelta;
+	double skew = 0, adjust, interval = 0, deltaskew, maxdelta;
+	struct timex tmx;
+	int result, saved_errno;
+
+	gettimeofday(&tnow, NULL);
+	adjust = (double)delta->tv_sec;
+	adjust += (double)delta->tv_usec / 1000000;
+
+	/* Even if the caller doesn't care about the olddelta, we do */
+	if (olddelta == NULL)
+		olddelta = &tdelta;
+
+	result = adjtime(delta, olddelta);
+	saved_errno = errno;
+
+	if (olddelta->tv_sec != 0 || olddelta->tv_usec != 0)
+		synced = 0;
+	else if (synced < 10)
+		++synced;
+
+	/*
+	 * do skew calculations if we have synced
+	 */
+	if (synced == 0) {
+		tmx.modes = 0;
+		if (adjtimex(&tmx) == -1)
+			log_warn("adjtimex get failed");
+		else
+			tskew = (double)tmx.freq / ADJTIMEX_FREQ_SCALE;
+	} else if (synced > 0) {
+		interval = (double)(tnow.tv_sec - tlast.tv_sec);
+		interval += (double)(tnow.tv_usec - tlast.tv_usec) / 1000000;
+
+		skew = (adjust * 1000000) / interval;
+		deltaskew = skew / synced;
+		maxdelta = MAX_SKEW_DELTA / synced;
+
+		if (skew > maxdelta) {
+			log_info("skew change %0.3lf exceeds limit", skew);
+			tskew += maxdelta;
+		} else if (skew < -maxdelta) {
+			log_info("skew change %0.3lf exceeds limit", skew);
+			tskew -= maxdelta;
+		} else {
+			tskew += deltaskew;
+		}
+
+		/* Adjust the kernel skew.  */
+		tmx.freq = (long)(tskew * ADJTIMEX_FREQ_SCALE);
+		tmx.modes = ADJ_FREQUENCY;
+		if (adjtimex(&tmx) == -1)
+			log_warn("adjtimex set freq failed");
+	}
+
+	log_debug("interval %0.3lf skew %0.3lf total skew %0.3lf", interval,
+	    skew, tskew);
+
+	tlast = tnow;
+	errno = saved_errno;
+	return result;
+}
+#endif
